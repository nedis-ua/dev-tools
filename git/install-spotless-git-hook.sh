#!/usr/bin/env bash
# ----------------------------------------------------------------------------------------------------------------------
HOOKS_DIR=.git/hooks
HOOK_NAME=pre-commit
# ----------------------------------------------------------------------------------------------------------------------
# Exit when any command fails
set -eu -o pipefail
# ----------------------------------------------------------------------------------------------------------------------
if [[ $# -eq 0 ]]; then
  WGET_QUITE=""
elif [[ $1 == "-q" ]]; then
  WGET_QUITE="-q"
else
  WGET_QUITE=""
fi
# ----------------------------------------------------------------------------------------------------------------------
# Verify that the current dir is a git repository:
if [[ ! -d "$HOOKS_DIR" ]]; then
  echo "------------------------------------------------------------------------" >&2
  echo "'${HOOKS_DIR}' not found. Is the '${PWD}' a git repository?" >&2
  echo "------------------------------------------------------------------------" >&2
  exit 1
fi
# ----------------------------------------------------------------------------------------------------------------------
# Verify that the pre-commit hook is not installed:
HOOK_PATH=${HOOKS_DIR}/${HOOK_NAME}
if [[ -f "$HOOK_PATH" ]]; then
  echo "------------------------------------------------------------------------" >&2
  echo "'${HOOK_PATH}' already exists. Skip installation." >&2
  echo "------------------------------------------------------------------------" >&2
  exit 2
fi
# ----------------------------------------------------------------------------------------------------------------------
# Verify that the wget is available:
set +e
WGET_CMD=$(which wget)
set -e
if [[ ! -x "$WGET_CMD" ]]; then
  echo "------------------------------------------------------------------------" >&2
  echo "Download and add \"wget\" to the \"PATH\" variable, before using this script!" >&2
  echo "------------------------------------------------------------------------" >&2
  exit 3
fi
# ----------------------------------------------------------------------------------------------------------------------
# Create the pre-commit hook
cd ${HOOKS_DIR}
{
echo "#!/bin/sh"
echo ""
echo "./gradlew spotlessApply && git add --all"
} > pre-commit
# Make the pre-commit executable
chmod 755 pre-commit
# ----------------------------------------------------------------------------------------------------------------------
# Show the success message
echo "------------------------------------------------------------------------"
echo "'${HOOK_NAME}' installed successful."
echo "------------------------------------------------------------------------"